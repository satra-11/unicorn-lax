# ER図

IndexedDB (`photo-selector-db`) のエンティティ関連図。

```mermaid
erDiagram
    ProcessingSession {
        string id PK "セッションID (UUID)"
        string folderName "フォルダ名"
        number totalFiles "総ファイル数"
        number processedCount "処理済み件数"
        string status "scanning | processing | completed | paused"
        number createdAt "作成日時 (Unix ms)"
        number updatedAt "更新日時 (Unix ms)"
    }

    Photo {
        string id PK "写真ID (UUID)"
        string sessionId FK "セッションID"
        string name "ファイル名"
        string relativePath "相対パス"
        number timestamp "タイムスタンプ (Unix ms)"
        string dateStr "日付 (ISO 8601)"
        string hash "重複検知用ハッシュ (INDEX)"
        string detectionModel "ssd | tiny"
        boolean noFaceMatch "顔未検出フラグ"
        boolean excluded "除外フラグ"
        blob thumbnail "サムネイル画像"
    }

    Face {
        Float32Array descriptor "顔特徴量ベクトル (128次元)"
        object box "検出領域 (x, y, width, height)"
        blob thumbnail "顔切り抜き画像"
    }

    FaceCluster {
        string id PK "クラスタID (UUID)"
        string label "ラベル名 (例: Person 1)"
        Float32Array descriptor "重心特徴量ベクトル"
        blob thumbnail "代表顔画像"
        number similarityThreshold "類似度しきい値 (default 0.4)"
    }

    ProcessingSession ||--o{ Photo : "contains"
    Photo ||--o{ Face : "detected faces"
    FaceCluster }o--o{ Photo : "photoIds / confirmedPhotoIds"
```

## エンティティ説明

| エンティティ          | ObjectStore 名             | Key  | インデックス                            | 説明                     |
| :-------------------- | :------------------------- | :--- | :-------------------------------------- | :----------------------- |
| **ProcessingSession** | `sessions`                 | `id` | —                                       | 写真取り込みセッション   |
| **Photo**             | `photos`                   | `id` | `by-session`, `by-timestamp`, `by-hash` | 写真メタデータ＋検出結果 |
| **Face**              | — (Photo 内の埋め込み配列) | —    | —                                       | 検出された個別の顔情報   |
| **FaceCluster**       | `clusters`                 | `id` | —                                       | 顔クラスタリング結果     |

## リレーション説明

| 関連                      | カーディナリティ | 説明                                                                       |
| :------------------------ | :--------------- | :------------------------------------------------------------------------- |
| ProcessingSession → Photo | 1 : N            | 1つのセッションに複数の写真が属する (`Photo.sessionId` で参照)             |
| Photo → Face              | 1 : N            | 1つの写真から複数の顔が検出される (`Photo.faces[]` に埋め込み)             |
| FaceCluster ↔ Photo       | N : M            | `FaceCluster.photoIds[]` および `confirmedPhotoIds[]` で多対多の関連を保持 |
